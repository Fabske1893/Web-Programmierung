<!DOCTYPE html>
<html lang="de">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezeptdetails</title>
    <link rel="stylesheet" href="../css/styleRecipeDetails.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../js/functions.js" defer></script>
</head>
<Header>
<nav>
    <a href="../Homepage.html">Startseite</a>
</nav>

</Header>
<body>
    <div id="recipe-content">
        <h1 id="recipe-title">Lade Rezept...</h1>
        <img id="recipe-image" alt="Rezeptbild">
        <div id="recipe-meta"></div>
        <div id="recipe-details">
            <div id="recipe-ingredients"></div>
            <div id="recipe-instructions"></div>
        </div>
    </div>

    <div id="recipe-actions">
        <button id="addToShoppingListButton">Zutaten zur Einkaufsliste hinzufügen</button>
        <button id="sendRecipeEmailButton">Rezept per E-Mail senden</button>
        <button id="likeButton" onclick="likeRecipe()">Like</button>
        <button onclick="readInstructions()">Zubereitung von Alexa vorlesen lassen</button>
    </div>

    <script>
    // ID aus der URL lesen
    const urlParams = new URLSearchParams(window.location.search);
    const recipeId = urlParams.get('id');
    let loadedRecipe = null;

    // Delegated handlers bound once
    if (window.$) {
        $(document).off('click.addList', '#addToShoppingListButton').on('click.addList', '#addToShoppingListButton', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!loadedRecipe || !Array.isArray(loadedRecipe.ingredients)) return;
            try {
                const shoppingList = JSON.parse(localStorage.getItem('shoppingList')) || {};
                (loadedRecipe.ingredients || []).forEach(i => {
                    const key = (i.name || '').toLowerCase().trim();
                    if (!key) return;
                    const current = shoppingList[key] || { amount: 0, unit: i.unit || '', name: i.name || '' };
                    const addAmt = (typeof i.amount === 'number') ? i.amount : 0;
                    const unitsEqual = (current.unit || '') === (i.unit || '');
                    shoppingList[key] = {
                        name: i.name || current.name || key,
                        unit: unitsEqual ? (current.unit || i.unit || '') : (current.unit || i.unit || ''),
                        amount: unitsEqual ? ((current.amount || 0) + addAmt) : (current.amount || 0)
                    };
                });
                localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
                alert('Zutaten zur Einkaufsliste hinzugefügt.');
            } catch (e) {
                console.error('Fehler beim Aktualisieren der Einkaufsliste:', e);
                alert('Fehler: Einkaufsliste konnte nicht aktualisiert werden.');
            }
        });

        $(document).off('click.mailRecipe', '#sendRecipeEmailButton').on('click.mailRecipe', '#sendRecipeEmailButton', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const token = localStorage.getItem('userToken');
            if (!token || token === 'OFF') {
                alert('Fehler: Du musst eingeloggt sein.');
                return;
            }
            fetch(`https://rezeptappbackend-a9a2cded5f95.herokuapp.com/api/recipes/${recipeId}/send-email?token=${encodeURIComponent(token)}`, {
                method: 'POST'
            })
            .then(r => r.json().then(body => ({ status: r.status, body })))
            .then(({ status, body }) => {
                if (status >= 200 && status < 300) {
                    alert(body.message || 'Rezept wurde per E-Mail gesendet.');
                } else if (status === 401) {
                    alert(body.message || 'Nicht eingeloggt.');
                } else {
                    alert(body.message || 'E-Mail konnte nicht gesendet werden.');
                }
            })
            .catch(err => {
                console.error('Fehler beim Senden des Rezepts:', err);
                alert('Netzwerkfehler beim Senden des Rezepts.');
            });
        });
    }

    if (!recipeId) {
        document.getElementById('recipe-content').innerHTML = '<h1>Fehler: Keine Rezept-ID angegeben</h1>';
    } else {
       
        const graphqlQuery = `
            query GetRecipe($id: Int!) {
                recipe(id: $id) {
                    id
                    title
                    imageUrl
                    category
                    difficulty
                    ingredients {
                        amount
                        unit
                        name
                    }
                    instructions
                    likes
                    
                }
            }
        `;
        $(document).ready(function() {
            $.ajax({
                url: 'https://rezeptappbackend-a9a2cded5f95.herokuapp.com/graphql',
                type: 'post',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({
                    query: graphqlQuery,
                    variables: { id: parseInt(recipeId, 10) }
                }),
                success: function(response) {
                    if (response.data && response.data.recipe) {
                        const recipe = response.data.recipe;
                        loadedRecipe = recipe;
                        
                        // Titel
                        document.getElementById('recipe-title').textContent = recipe.title;
                        
                        // Rezept-Informationen
                        const metaHtml = `
                            <p>Kategorie: ${recipe.category}</p>
                            <p>Schwierigkeit: ${recipe.difficulty}</p>
                            <p>Likes: ${recipe.likes}</p>
                        `;
                        document.getElementById('recipe-meta').innerHTML = metaHtml;
                        
                        // Bild korrekt auf <img>-Element setzen (mit Fallback)
                        (function(){
                            const imgEl = document.getElementById('recipe-image');
                            if (!imgEl) return;
                            imgEl.src = recipe.imageUrl || '../images/placeholder.png';
                            imgEl.alt = recipe.title || 'Rezeptbild';
                            imgEl.onerror = function(){
                                this.onerror = null;
                                this.src = '../images/placeholder.png';
                            };
                        })();
                        
                        // Zutaten
                        if (Array.isArray(recipe.ingredients) && recipe.ingredients.length > 0) {
                            const items = recipe.ingredients.map(i => {
                                const amount = (typeof i.amount === 'number' && i.amount > 0) ? i.amount : '';
                                const unit = i.unit ? ` ${i.unit}` : '';
                                const name = i.name || '';
                                const prefix = amount !== '' ? `${amount}${unit} ` : '';
                                return `<li>${prefix}${name}</li>`;
                            }).join('');
                            const ingredientsHtml = `
                                <h2>Zutaten</h2>
                                <ul>${items}</ul>
                            `;
                            document.getElementById('recipe-ingredients').innerHTML = ingredientsHtml;
                        }


                        // Zubereitung
                        if (recipe.instructions) {
                            document.getElementById('recipe-instructions').innerHTML = `
                                <h2>Zubereitung</h2>
                                <div class="instructions">${recipe.instructions}</div>
                            `;
                        }
                    } else {
                        document.getElementById('recipe-content').innerHTML = 
                            '<h1>Fehler: Rezept nicht gefunden</h1>';
                    }
                },
                error: function(xhr, status, error) {
                    document.getElementById('recipe-content').innerHTML = 
                        `<h1>Fehler beim Laden des Rezepts</h1><p>${error}</p>`;
                }
            });
        });
    }

    function readInstructions() {
      const recipeId = new URLSearchParams(window.location.search).get("id");
      fetch(`https://rezeptappbackend-a9a2cded5f95.herokuapp.com/alexa/recipe?id=${recipeId}`)
        .then(res => res.text())
        .then(text => {
          alert("Alexa sagt: " + text);
          // Optional: hier kannst du später die Alexa-API triggern
        })
        .catch(err => {
          console.error("Fehler bei Alexa-Request:", err);
          alert("Fehler: " + err.message);
        });
    }
</script>
</body>
</html>