<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Füge ein neues Rezept hinzu</title>
    <link rel="stylesheet" href="../css/styleCreateRecipe.css">
    <script type="text/javascript" src="../js/jquery-3.6.0.min.js"></script>
</head>
<header>
<nav>
    <a href="../Homepage.html">Startseite</a> &nbsp;&nbsp;
    <a href="../login/Logoff.html">Abmelden</a>
</nav>
<br>
</header>
<body>
     <form id="recipeForm" method="POST" enctype="multipart/form-data">
    <h1>Teilen sie ihre eigenen Rezepte mit anderen!</h1> <br>
    <h2>Füge ein neues Rezept hinzu:</h2>
    <p></p>

        <label for="recipeTitel" >Titel:</label> <br>
        <textarea type="text" id="recipeTitel" name="titel" required ></textarea><br><br>

    
        <label for="bild">Bild hochladen:</label> <br>
        <input type="file" id="bild" name="bild" accept="image/*"><br><br>
    

        <label for="zutaten">Zutaten:</label> <br>
        <textarea type="text" id="zutaten" name="zutaten" required ></textarea><br><br>

        <label for="zubereitung">Zubereitung:</label> <br>
        <textarea type="text" id="zubereitung" name="zubereitung" required ></textarea><br><br>

        <label for="difficulty">Schwierigkeitsgrad:</label>
        <select id="difficulty" name="difficulty">
            <option value="leicht">Leicht</option>
            <option value="mittel">Mittel</option>
            <option value="schwer">Schwer</option>
        </select><br><br>  

        <label for="category">Kategorie:</label>
        <select id="category" name="category">
            <option value="vegan">Vegan</option>
            <option value="vegetarian">Vegetarisch</option>
            <option value="includingMeat">Mit Fleisch</option>
        </select><br><br>  

        <button id="createRecipeButton" type="button">Erstellen</button>
        </form>

        <!--Über das Script nochmal drüber schauen-->
        <script>
        // Finde das Formular
    const recipeForm = document.getElementById('recipeForm');

    // Fange das "submit"-Ereignis des Formulars ab
    recipeForm.addEventListener('submit', function(event) {
        // Verhindere das Neuladen der Seite
        event.preventDefault(); 
        addRecipe();
    });

    function addRecipe() {
        // 1. Zutaten-Textfeld auslesen
        const ingredientsText = $("#zutaten").val();
        
        // 2. Zutaten-Text in die Objektstruktur umwandeln
        const ingredientsList = parseIngredients(ingredientsText);

        // 3. Das finale Rezept-Objekt erstellen
        const recipeData = {
            name: $("#recipeTitel").val(),
            pictureUrl: "default.jpg", // Platzhalter, da Bild-Upload komplexer ist
            ingredients: ingredientsList, // Die Liste der Zutat-Objekte
            instructions: $("#zubereitung").val(), // KORRIGIERT: 'instructions'
            difficultyLevel: $("#difficulty").val(),
            category: $("#category").val()
        };

        // 4. AJAX-Aufruf an dein LIVE Heroku Backend
        $.ajax({
            url: 'https://rezeptappbackend-a9a2cded5f95.herokuapp.com/api/recipes', // KORRIGIERTE URL
            type: 'POST',
            contentType: 'application/json', // Wir senden JSON
            data: JSON.stringify(recipeData), // Das Objekt in einen JSON-Text umwandeln
            success: function(response) {
                alert('Dein Rezept wurde erfolgreich hinzugefügt!');
                window.location.href = '../Homepage.html'; // Weiterleitung
            },
            error: function(xhr, status, error) {
                // Zeige eine detailliertere Fehlermeldung
                let errorMsg = 'Fehler: Wir konnten dein Rezept nicht hinzufügen.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg += '\nServer sagt: ' + xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMsg += '\nFehler: Netzwerkproblem oder Backend nicht erreichbar.';
                } else {
                    errorMsg += '\nStatus: ' + xhr.status;
                }
                alert(errorMsg);
                console.error("Fehlerdetails:", error);
            }
        });
    }

    /**
     * Wandelt den Text aus dem Zutatenfeld in eine Objekt-Liste um.
     * Format: "Menge Einheit Name"
     */
    function parseIngredients(text) {
        const lines = text.split('\n');
        const ingredients = [];
        lines.forEach(line => {
            line = line.trim();
            if (!line) return;
            
            // Versucht, Menge, Einheit und Name zu trennen
            const parts = line.match(/^(\d*\.?\d*)\s*([a-zA-Z]*)\s*(.*)/);
            let amount = 0;
            let unit = '';
            let name = line; // Fallback

            if (parts && parts[3]) { // Nur wenn alle Teile gefunden wurden
                amount = parseFloat(parts[1]) || 0;
                unit = parts[2] || '';
                name = parts[3].trim();
            } else {
                name = line.trim(); // Nur Name, wenn Format nicht passt
            }
            
            if (name) {
                 ingredients.push({ amount: amount, unit: unit, name: name });
            }
        });
        return ingredients;
    }
    </script>
</body>
</html>