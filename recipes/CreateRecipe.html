<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Füge ein neues Rezept hinzu</title>
  <link rel="stylesheet" href="../css/styleCreateRecipe.css">
  <script src="../js/jquery-3.6.0.min.js"></script>
</head>

<header>
  <nav>
    <a href="../Homepage.html">Startseite</a> &nbsp;&nbsp;
  </nav>
  <br>
</header>

<body>
  <!-- Formular -->
  <form id="recipeForm" method="POST" enctype="multipart/form-data">
    <h1>Teilen Sie Ihre eigenen Rezepte mit anderen!</h1><br>
    <h2>Füge ein neues Rezept hinzu:</h2><br>

    <label for="recipeTitel">Titel:</label><br>
    <textarea id="recipeTitel" name="titel" required></textarea><br><br>

    <label for="image">Bild hochladen:</label><br>
    <input type="file" id="image" name="image" accept="image/*"><br><br>

    <label for="zutaten">Zutaten:</label><br>
    <textarea id="zutaten" name="zutaten" required></textarea><br><br>

    <label for="zubereitung">Zubereitung:</label><br>
    <textarea id="zubereitung" name="zubereitung" required></textarea><br><br>

    <label for="difficulty">Schwierigkeitsgrad:</label><br>
    <select id="difficulty" name="difficulty">
      <option value="leicht">Leicht</option>
      <option value="mittel">Mittel</option>
      <option value="schwer">Schwer</option>
    </select><br><br>

    <label for="category">Kategorie:</label><br>
    <select id="category" name="category">
      <option value="vegan">Vegan</option>
      <option value="vegetarian">Vegetarisch</option>
      <option value="includingMeat">Mit Fleisch</option>
    </select><br><br>

    <button id="createRecipeButton" type="button" onclick="addRecipe()">Erstellen</button>
  </form>

  <!-- Script -->
  <script>
$(document).ready(function () {
  const token = localStorage.getItem("userToken");

  if (!token || token === "OFF") {
    alert("Bitte logge dich ein, um ein Rezept hinzuzufügen.");
    window.location.href = "../login/Login.html";
    return;
  }

  console.log("✅ Benutzer ist eingeloggt – Zugriff erlaubt.");
});

function addRecipe() {
  const ingredientsText = $("#zutaten").val();
  const ingredientsList = parseIngredients(ingredientsText);

  const formData = new FormData();
  formData.append("titel", $("#recipeTitel").val());
  formData.append("zutaten", JSON.stringify(ingredientsList));
  formData.append("zubereitung", $("#zubereitung").val());
  formData.append("difficulty", $("#difficulty").val());
  formData.append("category", $("#category").val());
  formData.append("likes", 0);
  formData.append("created_by", localStorage.getItem("userToken"));

  const fileInput = $("#image")[0];
  if (fileInput.files.length > 0) {
    formData.append("image", fileInput.files[0]);
  }

  $.ajax({
    url: "https://rezeptappbackend-a9a2cded5f95.herokuapp.com/api/recipes",
    type: "POST",
    data: formData,
    processData: false,
    contentType: false,
    success: function (response) {
      alert("✅ Dein Rezept wurde erfolgreich hinzugefügt!");
      window.location.href = "../Homepage.html";
    },
    error: function (xhr, status, error) {
      console.error("Fehlerdetails:", xhr, status, error);
      alert("❌ Fehler beim Hinzufügen des Rezepts.\nStatus: " + xhr.status + "\n" + xhr.responseText);
    }
  });
}

function parseIngredients(text) {
  const lines = text.split("\n");
  const ingredients = [];
  lines.forEach(line => {
    line = line.trim();
    if (!line) return;
    const parts = line.match(/^(\d*\.?\d*)\s*([a-zA-Z]*)\s*(.*)/);
    let amount = 0;
    let unit = '';
    let name = line;
    if (parts && parts[3]) {
      amount = parseFloat(parts[1]) || 0;
      unit = parts[2] || '';
      name = parts[3].trim();
    } else {
      name = line.trim();
    }
    if (name) {
      ingredients.push({ amount, unit, name });
    }
  });
  return ingredients;
}
</script>
</body>
</html>
