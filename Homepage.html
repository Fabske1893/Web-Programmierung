<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rezept- und Einkaufslisten App</title>
    <link rel="stylesheet" href="./css/style.css">
    <!-- Load local jQuery once -->
    <script src="./js/jquery-3.6.0.min.js"></script>
    <style>
        /* small layout helper so recipe cards align */
        #recipeContainer { display: flex; flex-wrap: wrap; gap: 1rem; }
        .recipe { width: 220px; border: 1px solid #ddd; padding: 0.5rem; box-sizing: border-box; }
        .recipe img { width: 100%; height: auto; display:block; }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="login/Login.html">Log in</a> &nbsp;&nbsp;
            <a href="login/Logoff.html">Log off</a> &nbsp;&nbsp;
            <a href="recipes/CreateRecipe.html">Rezept hinzufügen</a> &nbsp;&nbsp;
            <a href="ShoppingList.html">Einkaufsliste</a> &nbsp;&nbsp;
            <div id="adminLink" style="display: none; margin: 0; padding: 0; display: inline;">
                <a href="admin/adminUI.html">Rezepte löschen</a> &nbsp;&nbsp;
            </div>
            <img src="images/account.png" alt="Logo" class="logo" onclick="goToAccount()">
        </nav>
    </header>

    <main>
        <h1>Rezept und Einkaufslisten App</h1>
        <h2>Willkommen zur Rezept und Einkaufslisten App!</h2>
        <p>Finden Sie neue leckere Rezepte oder stellen Sie ihre Rezepte ganz einfach anderen zur Verfügung!</p>

        <div id="filterSortContainer">
            <div>
                <label for="filter">Filtern nach Schwierigkeitsgrad:</label> <br>
                <select name="filter" id="filter">
                    <option value="all">Alle</option>
                    <option value="easy">Einfach</option>
                    <option value="medium">Mittel</option>
                    <option value="hard">Schwer</option>
                </select>
            </div>

            <div>
                <label for="filterCategory">Filtern nach Kategorie:</label> <br>
                <select name="filterCategory" id="filterCategory">
                    <option value="all">Alle</option>
                    <option value="vegan">Vegan</option>
                    <option value="vegetarian">Vegetarisch</option>
                    <option value="withMeat">Mit Fleisch</option>
                </select>
            </div>

            <div id="sortRecipes">
                <label for="sort">Sortieren nach:</label> <br>
                <select name="sort" id="sort">
                    <option value="likes">Meiste Likes</option>
                    <option value="alphabet">A-Z</option>
                    <option value="date">Neuste zuerst</option>
                </select>
            </div>

            <div>
                <input type="search" name="searchRecipe" id="searchRecipe" placeholder="Suche Rezept..." oninput="searchRecipe()">
            </div>
        </div>

        <section>
            <!-- Container the sorting/filtering code expects -->
            <div id="recipeContainer"></div>
        </section>

        <!-- GraphQL loader: renders .recipe elements with required data-attributes -->
        <script>
            const graphqlQuery = `query { recipes { id imageUrl title difficulty category likes } }`;

            $(document).ready(function() {
                console.log("Sending POST on recipe of BFF with GraphQL query ...");
                $.ajax({
                    url : 'https://rezeptappbackend-a9a2cded5f95.herokuapp.com/graphql',
                    type : 'post',
                    contentType: 'application/json',
                    dataType : 'json',
                    data: JSON.stringify({ query: graphqlQuery }),
                    success : function(response) {
                        console.log('Rezepte erfolgreich geladen.');
                        const recipes = response?.data?.recipes || [];
                        const container = document.getElementById('recipeContainer');
                        container.innerHTML = '';

                        recipes.forEach(recipe => {
                            const div = document.createElement('div');
                            div.className = 'recipe';
                            div.setAttribute('data-name', (recipe.title || '').toLowerCase());
                            div.setAttribute('data-date', recipe.creationDate || new Date().toISOString());
                            div.setAttribute('data-difficulty', (recipe.difficulty || '').toLowerCase());
                            div.setAttribute('data-likes', recipe.likes || 0);

                            div.innerHTML = `
                                <a href="./recipes/recipe-detail.html?id=${recipe.id}">
                                    <img src="${recipe.imageUrl || 'images/placeholder.png'}" alt="${recipe.title || ''}">
                                </a>
                                <h3>${recipe.title || 'Untitled'}</h3>
                                <p><strong>Kategorie:</strong> ${recipe.category || '—'}</p>
                                <p><strong>Likes:</strong> ${recipe.likes || 0}</p>
                                <p><strong>Schwierigkeit:</strong> ${recipe.difficulty || '—'}</p>
                            `;

                            container.appendChild(div);
                        });
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert('Rezepte konnten nicht geladen werden.');
                    }
                });
            });
        </script>

    </main>

    <footer>
        <nav>
            <a href="./legal/Impressum.html">Impressum</a> &nbsp;&nbsp;
            <a href="./legal/Datenschutz.html">Datenschutz</a> &nbsp;&nbsp;
            <a href="login/Account.html">Mein Account</a> &nbsp;&nbsp;
        </nav>
    </footer>

    <script src="js/functions.js" defer></script>
    <script src="js/sortRecipes.js" defer></script>
</body>
</html>